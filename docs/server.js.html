<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: server.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: server.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>var http = require('http');
var fs = require('fs');
var assert = require('assert');
var url = require('url');
var qs = require('querystring');

var _SLUG_CHARACTER_SET = function () {
    var characterSet = '';
    for (var i = 48; i &lt;= 57; i++) {
      characterSet += String.fromCharCode(i);
    }
    for (i = 65; i &lt;= 90; i++) {
      characterSet += String.fromCharCode(i);
    }
    for (i = 97; i &lt;= 122; i++) {
      characterSet += String.fromCharCode(i);
    }
    return characterSet;
  }(),
  _SERVER_HOSTNAME = '127.0.0.1',
  _SERVER_PORT = 1337;

/**
 * Helper function to extract a URL from a slug file, if it exists.
 *
 * @param {string} slug slug to lookup
 * @param {function} callback function to invoke upon obtaining the slug contents or encountering an error
 */
function lookupSlugFile(slug, callback) {
  fs.readFile('./slugs/' + slug, function (err, data) {
    if (err) {
      callback(err);
    }
    else {
      callback(null, data.toString());
    }
  });
}
/**
 * Locates a slugified URL as long as the slug exists.
 *
 * @param {string} slug slug to lookup
 * @param {function} callback function to invoke once the URL is obtained or an error is encountered
 */
function locateSlug(slug, callback) {
  if (!callback) {
    throw new Error('callback not defined');
  }
  if (!slug) {
    callback(new Error('slug not valid'));
    return;
  }
  slug = slug.replace(/\//g, '');
  if (!slug.match(/^[a-z0-9]+$/i)) {
    callback(new Error('slug not valid'));
    return;
  }

  lookupSlugFile(slug, callback);
}

/**
 * Recursive function to find the next available slug.
 *
 * @param {string} slug the current slug to check for existence or to write to
 * @param {string} urlToSlug the URL contents of target slug file
 * @param {function} callback the callback function to execute when an available slug is found
 */
function findAvailableSlug(slug, urlToSlug, callback) {
  fs.exists('./slugs/' + slug, function (exists) {
    if (exists) {
      slug += getRandomSlugCharacter();
      findAvailableSlug(slug, urlToSlug, callback);
    } else {
      callback(null, slug, urlToSlug);
    }
  });
}

/**
 * Fetches a random character from the slug character set.
 *
 * @returns {string} a random character from the slug character set
 */
function getRandomSlugCharacter() {
  var randomIndex = Math.floor(Math.random() * _SLUG_CHARACTER_SET.length);
  return _SLUG_CHARACTER_SET.charAt(randomIndex);
}
/**
 * Generates a new slug for the passed URL which will consist of at least one or
 * more characters, where each character is either a letter or a number.
 *
 * @param {string} urlToSlug URL to convert to slug form
 * @param {function} callback function to invoke once the slug is generated or an error is encountered
 */
function generateSlug(urlToSlug, callback) {
  if (!callback) {
    throw new Error('callback not defined');
  }
  if (!urlToSlug) {
    callback(new Error('url missing'));
    return;
  }
  var parsedUrl = url.parse(urlToSlug);
  if (!parsedUrl.hostname || !parsedUrl.protocol) {
    callback(new Error('not a valid url'));
    return;
  }

  // find a slug that is available
  var slug = getRandomSlugCharacter(slug);
  findAvailableSlug(slug, urlToSlug, function (err, newSlug, urlToSlug) {
    fs.writeFile('./slugs/' + newSlug, urlToSlug, function (err) {
      if (err) callback(err);
      else {
        callback(null, newSlug);
      }
      console.log(urlToSlug + ' -> ' + newSlug);
    });
  });

  /**
   * Rename is only guaranteed atomic operation on Linux/Unix kernel?
   *
   * http://stackoverflow.com/questions/17047994/transactionally-writing-files-in-node-js
   * http://nodejs.org/api/fs.html#fs_fs_rename_oldpath_newpath_callback
   */
}


/**
 * Entry point for URL shortening application.
 */
http.createServer(function (req, res) {

  console.log('Attempting to retrieve slug for: ' + req.url);

  if (req.url === '/new') {
    if (req.method !== 'POST') {
      res.writeHead(400, {'Content-Type': 'text/plain'});
      res.end();
    }
    var body = '';
    // node doesn't follow convention here (first param is not error status)
    req.on('data', function (data) {
      body += data;

      // Sanity check: kill the connection if we receive too much POST data
      if (body.length > 1e6) {
        req.connection.destroy();
      }
    });
    req.on('end', function () {
        var post = qs.parse(body);
        if (!post || !post['url']) {
          // 400 Bad Request or 422 Unprocessable Entity are appropriate HTTP status codes here
          res.writeHead(422, {});
          res.end();
        } else {
          var urlToSlug = post['url'];
          generateSlug(urlToSlug, function (error, newSlug) {
            if (!error) {
              res.writeHead(201, {'Content-Type': 'text/plain'});
              res.write(JSON.stringify({
                slug: newSlug,
                url: urlToSlug
              }));
              res.end();
            } else {
              res.writeHead(406, {'Content-Type': 'text/plain'});
              res.end();
            }
          });
        }
      }
    );
  } else {
    locateSlug(req.url, function (error, data) {
      if (!error) {
        res.writeHead(302, {'Content-Type': 'text/plain', 'Location': data});
        res.end();
      } else {
        res.writeHead(404, {'Content-Type': 'text/plain'});
        res.end('404 Not Found');
      }
    });
  }

}).listen(_SERVER_PORT, _SERVER_HOSTNAME);

console.log('Server running at http://' + _SERVER_HOSTNAME + ':' + _SERVER_PORT + '/');

// ===== UNIT TESTS ============================================================

// TODO: switch to nodeunit - https://github.com/caolan/nodeunit

// tests for locateSlug(str, fn)

// happy path - matching slug found
locateSlug('/s', function (error, data) {
  assert(error === null);
  assert.equal('http://www.shopify.com/', data);
});
// happy path - extra trailing slash should still match
locateSlug('/s/', function (error, data) {
  assert(error === null);
  assert.equal('http://www.shopify.com/', data);
});
// callback undefined
assert.throws(function () {
  locateSlug('/s', null);
}, Error, 'callback not defined');
// non-matching slug
locateSlug('/1234', function (error, data) {
  assert(error !== null);
});
// test for invalid characters in slug
locateSlug('/s-', function (error, data) {
  assert(error !== null);
});
// test for null/empty slug
locateSlug('', function (error, data) {
  assert(error !== null);
});

// tests for generateSlug(str, fn)

// happy path - slug should be generated for valid URL
generateSlug('http://www.google.com', function (error, data) {
  assert(data, 'slug should be non-empty');
});
// missing callback should result in thrown error
assert.throws(
  function() {
    generateSlug('http://www.google.com');
  }, Error, 'callback missing'
);
assert.throws(
  function() {
    generateSlug();
  }, Error, 'callback missing'
);
// blank url should result in error within callback
generateSlug('', function (error, data) {
  assert(error !== null);
});
// null url should result in error within callback
generateSlug(null, function (error, data) {
  assert(error !== null);
});</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Global</h3><ul><li><a href="global.html#findAvailableSlug">findAvailableSlug</a></li><li><a href="global.html#generateSlug">generateSlug</a></li><li><a href="global.html#getRandomSlugCharacter">getRandomSlugCharacter</a></li><li><a href="global.html#locateSlug">locateSlug</a></li><li><a href="global.html#lookupSlugFile">lookupSlugFile</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.4.0-dev</a> on Wed Feb 11 2015 23:40:03 GMT-0500 (EST)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
